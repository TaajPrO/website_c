<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ChatGPT-style (OpenRouter) Demo</title>

    <!-- Tailwind Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM UMD -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX in-browser (dev convenience only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      html,body,#root { height: 100%; }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="root" class="h-screen"></div>

    <script type="text/babel">

const { useState, useEffect, useRef } = React;

function ChatApp(){
  const [messages, setMessages] = useState([
    { role: 'assistant', content: 'Hi — I am powered by OpenRouter. Say hello!' }
  ]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const endRef = useRef(null);

  useEffect(() => { scrollToBottom(); }, [messages]);

  function scrollToBottom(){
    if(endRef.current) endRef.current.scrollIntoView({ behavior: 'smooth' });
  }

  async function sendMessage(e){
    e.preventDefault();
    const text = input.trim();
    if(!text) return;
    const userMsg = { role: 'user', content: text };
    const newMessages = [...messages, userMsg];
    setMessages(newMessages);
    setInput('');
    setLoading(true);

    try {
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: newMessages })
      });
      const data = await resp.json();
      if(!resp.ok){
        throw new Error(data.error || JSON.stringify(data));
      }
      // Attempt to extract assistant reply
      let assistantMessage = '[no response]';
      if (data.choices && data.choices.length > 0) {
        assistantMessage = data.choices[0].message?.content || data.choices[0].delta?.content || '[empty]';
      } else if (data.output) {
        assistantMessage = data.output;
      } else if (data.error) {
        assistantMessage = 'Error: ' + JSON.stringify(data.error);
      }

      setMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);

    } catch (err) {
      console.error(err);
      setMessages(prev => [...prev, { role: 'assistant', content: 'Error: ' + String(err) }]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="flex flex-col h-full">
      <header className="bg-gray-800 text-white p-4 text-center font-semibold">
        Chat — OpenRouter demo
      </header>

      <main className="flex-1 overflow-auto p-4">
        <div className="max-w-3xl mx-auto space-y-3">
          {messages.map((m, idx) => (
            <div key={idx} className={m.role === 'user' ? 'flex justify-end' : 'flex justify-start'}>
              <div className={m.role === 'user' ? 'bg-blue-600 text-white px-4 py-2 rounded-2xl max-w-[70%]' : 'bg-gray-200 text-gray-900 px-4 py-2 rounded-2xl max-w-[70%]'}>
                <div style={{whiteSpace: 'pre-wrap'}}>{m.content}</div>
              </div>
            </div>
          ))}
          <div ref={endRef} />
        </div>
      </main>

      <form onSubmit={sendMessage} className="p-4 bg-white border-t flex items-center gap-3">
        <input
          className="flex-1 border rounded-full px-4 py-2 focus:outline-none"
          placeholder="Type your message..."
          value={input}
          onChange={e => setInput(e.target.value)}
          disabled={loading}
        />
        <button className="bg-blue-600 text-white px-4 py-2 rounded-full" disabled={loading}>
          {loading ? 'Thinking...' : 'Send'}
        </button>
      </form>

      <footer className="text-center text-xs text-gray-500 p-2">
        This demo proxies requests through the server so your OpenRouter API key stays secret.
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<ChatApp />);

    </script>
  </body>
</html>
